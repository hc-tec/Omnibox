# ä¸“å±ç ”ç©¶è§†å›¾å®Œæ•´å®æ–½æ–¹æ¡ˆ

## ç›®æ ‡

ç›´æ¥å®ç°ä¸“å±ç ”ç©¶è§†å›¾ï¼ˆæ–¹æ¡ˆCï¼‰ï¼Œæä¾›æ²‰æµ¸å¼çš„æ·±åº¦ç ”ç©¶ä½“éªŒã€‚

---

## æ•´ä½“æ¶æ„è®¾è®¡

### è§†å›¾ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡¶éƒ¨å¯¼èˆªæ                                                     â”‚
â”‚ [â† è¿”å›ä¸»ç•Œé¢] [ç ”ç©¶æ ‡é¢˜] [å¯¼å‡ºæŠ¥å‘Š] [åˆ†äº«]                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                                          â”‚
â”‚  å·¦ä¾§é¢æ¿ (30%)  â”‚  å³ä¾§é¢æ¿ (70%)                           â”‚
â”‚                  â”‚                                          â”‚
â”‚  ç ”ç©¶ä¸Šä¸‹æ–‡åŒº     â”‚  æ•°æ®å¯è§†åŒ–åŒº                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ç ”ç©¶ç›®æ ‡     â”‚ â”‚  â”‚  Panelå¡ç‰‡    â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚æ‰§è¡Œæ­¥éª¤     â”‚ â”‚  â”‚  Panelå¡ç‰‡    â”‚                        â”‚
â”‚  â”‚ âœ… æ­¥éª¤1    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚  â”‚ ğŸ”„ æ­¥éª¤2    â”‚ â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                          â”‚
â”‚  â”‚AIåˆ†æç»“æœ   â”‚ â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                          â”‚
â”‚                  â”‚                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åº•éƒ¨äº¤äº’åŒºï¼ˆå¯é€‰ï¼‰                                            â”‚
â”‚ [è¿½é—®è¾“å…¥æ¡†] [å‘é€]                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åŠŸèƒ½æ¸…å•ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### P0ï¼ˆMVP - å¿…é¡»å®ç°ï¼‰

#### åç«¯
- [x] æ–°å¢ WebSocket æ¶ˆæ¯ç±»å‹ï¼ˆPanelMessageã€AnalysisMessageç­‰ï¼‰
- [x] æ”¹é€  `_handle_complex_research` ä¸ºæµå¼ç”Ÿæˆå™¨
- [x] æ–°å¢ `/api/v1/research/stream` WebSocket ç«¯ç‚¹
- [x] å®æ—¶æ¨é€ç ”ç©¶è¿›åº¦ã€æ•°æ®ã€åˆ†æç»“æœ

#### å‰ç«¯
- [x] åˆ›å»ºç ”ç©¶è§†å›¾è·¯ç”± `/research/:taskId`
- [x] å®ç° ResearchView ä¸»å®¹å™¨ç»„ä»¶
- [x] å®ç°å·¦ä¾§ç ”ç©¶ä¸Šä¸‹æ–‡é¢æ¿
  - [x] ç ”ç©¶ç›®æ ‡å±•ç¤º
  - [x] æ‰§è¡Œæ­¥éª¤åˆ—è¡¨ï¼ˆå®æ—¶æ›´æ–°ï¼‰
  - [x] AIåˆ†æç»“æœå±•ç¤º
- [x] å®ç°å³ä¾§æ•°æ®å¯è§†åŒ–é¢æ¿
  - [x] Panel å¡ç‰‡åŠ¨æ€æ¸²æŸ“
  - [x] å“åº”å¼å¸ƒå±€
- [x] å®ç°é¡¶éƒ¨å¯¼èˆªæ 
  - [x] è¿”å›ä¸»ç•Œé¢æŒ‰é’®
  - [x] ç ”ç©¶æ ‡é¢˜å±•ç¤º
- [x] WebSocket è¿æ¥ç®¡ç†
- [x] è§†å›¾çŠ¶æ€ç®¡ç†ï¼ˆresearchViewStoreï¼‰

### P1ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰

#### åç«¯
- [ ] ç ”ç©¶ä»»åŠ¡æŒä¹…åŒ–ï¼ˆå­˜å‚¨åˆ°æ•°æ®åº“ï¼‰
- [ ] å†å²ç ”ç©¶åˆ—è¡¨ API
- [ ] å¯¼å‡ºæŠ¥å‘Š APIï¼ˆMarkdown/PDFï¼‰

#### å‰ç«¯
- [ ] è¿½é—®å¯¹è¯åŠŸèƒ½ï¼ˆåº•éƒ¨è¾“å…¥æ¡†ï¼‰
- [ ] å¯¼å‡ºæŠ¥å‘ŠåŠŸèƒ½
- [ ] åˆ†äº«ç ”ç©¶åŠŸèƒ½ï¼ˆç”Ÿæˆå…¬å¼€é“¾æ¥ï¼‰
- [ ] å†å²ç ”ç©¶åˆ—è¡¨é¡µé¢
- [ ] Panel å¡ç‰‡å…¨å±æŸ¥çœ‹

### P2ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰

- [ ] ç ”ç©¶æ¨¡æ¿ç³»ç»Ÿ
- [ ] æ•°æ®å¯¹æ¯”æ¨¡å¼ï¼ˆåˆ†æ å¯¹æ¯”ï¼‰
- [ ] åä½œç ”ç©¶ï¼ˆå¤šäººå®æ—¶ï¼‰
- [ ] ç‰ˆæœ¬ç®¡ç†ï¼ˆç ”ç©¶å†å²ï¼‰
- [ ] è‡ªå®šä¹‰ç ”ç©¶æµç¨‹

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### ä¸€ã€åç«¯å®ç°

#### 1. æ–°å¢æ¶ˆæ¯ç±»å‹å®šä¹‰

**æ–‡ä»¶**ï¼š`api/schemas/stream_messages.py`ï¼ˆæ‰©å±•ç°æœ‰ï¼‰

```python
from enum import Enum
from typing import Any, Dict, List, Optional
from pydantic import BaseModel, Field


class ResearchMessageType(str, Enum):
    """ç ”ç©¶æ¶ˆæ¯ç±»å‹"""
    RESEARCH_START = "research_start"      # ç ”ç©¶å¼€å§‹
    RESEARCH_STEP = "research_step"        # æ­¥éª¤æ›´æ–°
    RESEARCH_PANEL = "research_panel"      # Panelæ•°æ®æ¨é€
    RESEARCH_ANALYSIS = "research_analysis"  # åˆ†æç»“æœ
    RESEARCH_COMPLETE = "research_complete"  # ç ”ç©¶å®Œæˆ
    RESEARCH_ERROR = "research_error"      # é”™è¯¯


class ResearchStartMessage(BaseModel):
    """ç ”ç©¶å¼€å§‹æ¶ˆæ¯"""
    type: str = "research_start"
    stream_id: str
    task_id: str
    query: str
    plan: Dict[str, Any]  # æŸ¥è¯¢è®¡åˆ’


class ResearchStepMessage(BaseModel):
    """ç ”ç©¶æ­¥éª¤æ¶ˆæ¯"""
    type: str = "research_step"
    stream_id: str
    task_id: str

    step_id: str
    step_type: str  # "planning" | "data_fetch" | "analysis"
    action: str  # æ­¥éª¤æè¿°
    status: str  # "processing" | "success" | "error"
    result_summary: Optional[str] = None
    execution_time: Optional[float] = None


class ResearchPanelMessage(BaseModel):
    """Panelæ•°æ®æ¨é€æ¶ˆæ¯"""
    type: str = "research_panel"
    stream_id: str
    task_id: str

    # å­æŸ¥è¯¢ä¿¡æ¯
    sub_query: str
    data_source: Optional[str] = None
    item_count: int

    # Panel æ•°æ®
    panel_payload: Dict[str, Any]  # PanelPayload
    data_blocks: Dict[str, Any]  # DataBlockæ˜ å°„


class ResearchAnalysisMessage(BaseModel):
    """åˆ†æç»“æœæ¶ˆæ¯"""
    type: str = "research_analysis"
    stream_id: str
    task_id: str

    query: str
    summary: str
    item_count: int
    execution_time: float


class ResearchCompleteMessage(BaseModel):
    """ç ”ç©¶å®Œæˆæ¶ˆæ¯"""
    type: str = "research_complete"
    stream_id: str
    task_id: str

    success: bool
    message: str
    total_time: float
    metadata: Dict[str, Any]
```

#### 2. æ”¹é€ ä¸ºæµå¼ç”Ÿæˆå™¨

**æ–‡ä»¶**ï¼š`services/chat_service.py`

æ–°å¢æ–¹æ³•ï¼š`_handle_complex_research_streaming`

```python
def _handle_complex_research_streaming(
    self,
    task_id: str,
    user_query: str,
    filter_datasource: Optional[str],
    use_cache: bool,
    intent_confidence: float,
    llm_logs: Optional[List[Dict[str, Any]]],
) -> Generator[Dict[str, Any], None, None]:
    """
    å¤„ç†å¤æ‚ç ”ç©¶æ„å›¾ï¼ˆæµå¼ç‰ˆæœ¬ï¼‰

    Yields:
        ResearchMessage æ¶ˆæ¯å­—å…¸
    """
    import time
    import uuid

    stream_id = str(uuid.uuid4())
    start_time = time.time()

    try:
        # æ­¥éª¤1ï¼šLLM è§„åˆ’
        yield {
            "type": "research_start",
            "stream_id": stream_id,
            "task_id": task_id,
            "query": user_query,
            "plan": {},
        }

        yield {
            "type": "research_step",
            "stream_id": stream_id,
            "task_id": task_id,
            "step_id": "planning",
            "step_type": "planning",
            "action": "LLM æ­£åœ¨è§„åˆ’ç ”ç©¶æ–¹æ¡ˆ",
            "status": "processing",
        }

        query_plan = self._llm_query_planner.plan(user_query)

        yield {
            "type": "research_step",
            "stream_id": stream_id,
            "task_id": task_id,
            "step_id": "planning",
            "step_type": "planning",
            "action": "LLM è§„åˆ’å®Œæˆ",
            "status": "success",
            "result_summary": f"{len(query_plan.sub_queries)} ä¸ªå­ä»»åŠ¡ï¼š{query_plan.reasoning}",
            "execution_time": 0.5,
        }

        # æ­¥éª¤2ï¼šæ‰§è¡Œæ•°æ®è·å–å­æŸ¥è¯¢
        data_sub_queries = [sq for sq in query_plan.sub_queries if sq.task_type == "data_fetch"]
        analysis_sub_queries = [sq for sq in query_plan.sub_queries if sq.task_type == "analysis"]

        success_results = []
        aggregated_datasets = []

        for idx, sub_query in enumerate(data_sub_queries, 1):
            step_id = f"fetch-{idx}"

            # æ¨é€å¼€å§‹æ¶ˆæ¯
            yield {
                "type": "research_step",
                "stream_id": stream_id,
                "task_id": task_id,
                "step_id": step_id,
                "step_type": "data_fetch",
                "action": f"è·å–æ•°æ®ï¼š{sub_query.query}",
                "status": "processing",
            }

            # æ‰§è¡ŒæŸ¥è¯¢
            step_start = time.time()

            query_result = self.data_query_service.query(
                user_query=sub_query.query,
                filter_datasource=sub_query.datasource,
                use_cache=use_cache,
                prefer_single_route=self._should_force_single_route(sub_query.datasource),
            )

            execution_time = time.time() - step_start

            if query_result.status == "success":
                # æ„å»º Panel æ•°æ®
                datasets = query_result.datasets or []
                aggregated_datasets.extend(datasets)

                panel_result = self._build_panel(datasets, sub_query.query)

                # æ¨é€ Panel æ•°æ®
                yield {
                    "type": "research_panel",
                    "stream_id": stream_id,
                    "task_id": task_id,
                    "sub_query": sub_query.query,
                    "data_source": sub_query.datasource,
                    "item_count": len(query_result.items),
                    "panel_payload": panel_result.payload.model_dump(),
                    "data_blocks": {
                        k: v.model_dump() for k, v in panel_result.data_blocks.items()
                    },
                }

                # æ¨é€æˆåŠŸæ¶ˆæ¯
                yield {
                    "type": "research_step",
                    "stream_id": stream_id,
                    "task_id": task_id,
                    "step_id": step_id,
                    "step_type": "data_fetch",
                    "action": f"è·å–æ•°æ®ï¼š{sub_query.query}",
                    "status": "success",
                    "result_summary": f"è·å– {len(query_result.items)} æ¡æ•°æ®",
                    "execution_time": execution_time,
                }

                success_results.append({
                    "sub_query": sub_query,
                    "result": query_result,
                    "execution_time": execution_time,
                })
            else:
                # æ¨é€å¤±è´¥æ¶ˆæ¯
                yield {
                    "type": "research_step",
                    "stream_id": stream_id,
                    "task_id": task_id,
                    "step_id": step_id,
                    "step_type": "data_fetch",
                    "action": f"è·å–æ•°æ®ï¼š{sub_query.query}",
                    "status": "error",
                    "result_summary": query_result.reasoning or "æ•°æ®è·å–å¤±è´¥",
                    "execution_time": execution_time,
                }

        # æ­¥éª¤3ï¼šæ‰§è¡Œåˆ†æå­æŸ¥è¯¢
        for idx, sub_query in enumerate(analysis_sub_queries, 1):
            step_id = f"analysis-{idx}"

            yield {
                "type": "research_step",
                "stream_id": stream_id,
                "task_id": task_id,
                "step_id": step_id,
                "step_type": "analysis",
                "action": f"AI åˆ†æï¼š{sub_query.query}",
                "status": "processing",
            }

            step_start = time.time()

            # æ‰§è¡Œåˆ†æ
            analysis_summaries = self._run_analysis_sub_queries(
                [sub_query],
                aggregated_datasets
            )

            execution_time = time.time() - step_start

            if analysis_summaries:
                summary_data = analysis_summaries[0]

                # æ¨é€åˆ†æç»“æœ
                yield {
                    "type": "research_analysis",
                    "stream_id": stream_id,
                    "task_id": task_id,
                    "query": summary_data["query"],
                    "summary": summary_data["summary"],
                    "item_count": summary_data.get("item_count", 0),
                    "execution_time": execution_time,
                }

                # æ¨é€æˆåŠŸæ¶ˆæ¯
                yield {
                    "type": "research_step",
                    "stream_id": stream_id,
                    "task_id": task_id,
                    "step_id": step_id,
                    "step_type": "analysis",
                    "action": f"AI åˆ†æï¼š{sub_query.query}",
                    "status": "success",
                    "result_summary": "åˆ†æå®Œæˆ",
                    "execution_time": execution_time,
                }

        # æ­¥éª¤4ï¼šæ¨é€å®Œæˆæ¶ˆæ¯
        total_time = time.time() - start_time

        yield {
            "type": "research_complete",
            "stream_id": stream_id,
            "task_id": task_id,
            "success": True,
            "message": f"ç ”ç©¶å®Œæˆï¼š{len(success_results)} ç»„æ•°æ®ï¼Œ{len(analysis_sub_queries)} é¡¹åˆ†æ",
            "total_time": total_time,
            "metadata": {
                "query_plan": {
                    "reasoning": query_plan.reasoning,
                    "sub_query_count": len(query_plan.sub_queries),
                },
                "success_count": len(success_results),
                "failure_count": len(data_sub_queries) - len(success_results),
            }
        }

    except Exception as exc:
        logger.error("å¤æ‚ç ”ç©¶æµå¼å¤„ç†å¤±è´¥: %s", exc, exc_info=True)
        yield {
            "type": "research_error",
            "stream_id": stream_id,
            "task_id": task_id,
            "error_code": "RESEARCH_ERROR",
            "error_message": str(exc),
        }
```

#### 3. æ–°å¢ WebSocket ç«¯ç‚¹

**æ–°å¢æ–‡ä»¶**ï¼š`api/controllers/research_stream.py`

```python
"""
ç ”ç©¶æ¨¡å¼ WebSocket æµå¼æ§åˆ¶å™¨
ä¸“å±ç ”ç©¶è§†å›¾çš„å®æ—¶æ¨é€
"""

import logging
import asyncio
from typing import Any
from fastapi import APIRouter, WebSocket, WebSocketDisconnect, Depends
from uuid import uuid4

from api.controllers.chat_controller import get_chat_service

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/v1/research", tags=["research-stream"])


def generate_task_id() -> str:
    """ç”Ÿæˆç ”ç©¶ä»»åŠ¡ID"""
    return f"research-{uuid4().hex[:12]}"


@router.websocket("/stream")
async def research_stream_ws(
    websocket: WebSocket,
    chat_service: Any = Depends(get_chat_service)
):
    """
    ç ”ç©¶æ¨¡å¼ WebSocket æµå¼æ¥å£

    å®¢æˆ·ç«¯å‘é€ï¼š
    {
        "query": "ç”¨æˆ·æŸ¥è¯¢",
        "filter_datasource": null,
        "use_cache": true,
        "task_id": "å¯é€‰ï¼Œå‰ç«¯ç”Ÿæˆçš„ä»»åŠ¡ID"
    }

    æœåŠ¡ç«¯æ¨é€ï¼š
    - research_start: ç ”ç©¶å¼€å§‹
    - research_step: æ­¥éª¤æ›´æ–°
    - research_panel: Panelæ•°æ®
    - research_analysis: åˆ†æç»“æœ
    - research_complete: ç ”ç©¶å®Œæˆ
    - research_error: é”™è¯¯
    """
    await websocket.accept()
    task_id = None

    try:
        # æ¥æ”¶è¯·æ±‚
        request_data = await websocket.receive_json()
        user_query = request_data.get("query", "")
        filter_datasource = request_data.get("filter_datasource")
        use_cache = request_data.get("use_cache", True)
        task_id = request_data.get("task_id") or generate_task_id()

        logger.info(f"[{task_id}] æ”¶åˆ°ç ”ç©¶è¯·æ±‚: {user_query}")

        # éªŒè¯æŸ¥è¯¢
        if not user_query or not user_query.strip():
            await websocket.send_json({
                "type": "research_error",
                "task_id": task_id,
                "error_code": "VALIDATION_ERROR",
                "error_message": "æŸ¥è¯¢ä¸èƒ½ä¸ºç©º",
            })
            await websocket.close()
            return

        # æ£€æŸ¥æ˜¯å¦æœ‰æµå¼ç”Ÿæˆå™¨æ–¹æ³•
        if not hasattr(chat_service, '_handle_complex_research_streaming'):
            logger.error(f"[{task_id}] ChatService ç¼ºå°‘ _handle_complex_research_streaming æ–¹æ³•")
            await websocket.send_json({
                "type": "research_error",
                "task_id": task_id,
                "error_code": "METHOD_NOT_FOUND",
                "error_message": "ç ”ç©¶æµå¼å¤„ç†æ–¹æ³•æœªå®ç°",
            })
            await websocket.close()
            return

        # åˆ›å»ºæµå¼ç”Ÿæˆå™¨
        message_generator = chat_service._handle_complex_research_streaming(
            task_id=task_id,
            user_query=user_query,
            filter_datasource=filter_datasource,
            use_cache=use_cache,
            intent_confidence=0.9,
            llm_logs=None,
        )

        # é€ä¸ªæ¨é€æ¶ˆæ¯
        while True:
            try:
                message = await asyncio.to_thread(next, message_generator, None)
                if message is None:
                    break

                await websocket.send_json(message)
                logger.debug(f"[{task_id}] æ¨é€æ¶ˆæ¯: {message['type']}")

            except StopIteration:
                break
            except Exception as e:
                logger.error(f"[{task_id}] æ¶ˆæ¯æ¨é€å¤±è´¥: {e}", exc_info=True)
                break

        logger.info(f"[{task_id}] ç ”ç©¶æµå¼å¤„ç†å®Œæˆ")

    except WebSocketDisconnect:
        logger.info(f"[{task_id}] å®¢æˆ·ç«¯æ–­å¼€è¿æ¥")
    except Exception as e:
        logger.error(f"[{task_id}] WebSocket å¤„ç†å¤±è´¥: {e}", exc_info=True)
        try:
            await websocket.send_json({
                "type": "research_error",
                "task_id": task_id or "unknown",
                "error_code": "INTERNAL_ERROR",
                "error_message": str(e),
            })
        except:
            pass
    finally:
        try:
            await websocket.close()
            logger.info(f"[{task_id}] WebSocket è¿æ¥å·²å…³é—­")
        except:
            pass
```

#### 4. æ³¨å†Œè·¯ç”±

**ä¿®æ”¹æ–‡ä»¶**ï¼š`api/app.py`

```python
# å¯¼å…¥æ–°çš„ç ”ç©¶æµå¼è·¯ç”±
from api.controllers import research_stream

# æ³¨å†Œè·¯ç”±
app.include_router(research_stream.router)
```

---

### äºŒã€å‰ç«¯å®ç°

#### 1. è·¯ç”±é…ç½®

**ä¿®æ”¹æ–‡ä»¶**ï¼š`frontend/src/router/index.ts`ï¼ˆå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºï¼‰

```typescript
import { createRouter, createWebHistory } from 'vue-router';
import ResearchView from '@/views/ResearchView.vue';
import MainView from '@/views/MainView.vue';  // åŸæ¥çš„ App.vue å†…å®¹

const routes = [
  {
    path: '/',
    name: 'Home',
    component: MainView,
  },
  {
    path: '/research/:taskId',
    name: 'Research',
    component: ResearchView,
    props: true,
  },
];

const router = createRouter({
  history: createWebHistory(),
  routes,
});

export default router;
```

#### 2. ç ”ç©¶è§†å›¾ Store

**æ–°å¢æ–‡ä»¶**ï¼š`frontend/src/stores/researchViewStore.ts`

```typescript
import { defineStore } from 'pinia';
import { ref, computed } from 'vue';

export interface ResearchStep {
  step_id: string;
  step_type: 'planning' | 'data_fetch' | 'analysis';
  action: string;
  status: 'processing' | 'success' | 'error';
  result_summary?: string;
  execution_time?: number;
}

export interface ResearchPanel {
  sub_query: string;
  data_source?: string;
  item_count: number;
  panel_payload: any;
  data_blocks: Record<string, any>;
}

export interface ResearchAnalysis {
  query: string;
  summary: string;
  item_count: number;
  execution_time: number;
}

export interface ResearchTask {
  task_id: string;
  query: string;
  status: 'idle' | 'planning' | 'processing' | 'completed' | 'error';

  // ç ”ç©¶è®¡åˆ’
  plan?: {
    reasoning: string;
    sub_query_count: number;
  };

  // æ‰§è¡Œæ­¥éª¤
  steps: ResearchStep[];

  // Panel æ•°æ®
  panels: ResearchPanel[];

  // åˆ†æç»“æœ
  analyses: ResearchAnalysis[];

  // å…ƒæ•°æ®
  metadata?: {
    total_time?: number;
    success_count?: number;
    failure_count?: number;
  };

  // é”™è¯¯ä¿¡æ¯
  error?: string;
}

export const useResearchViewStore = defineStore('researchView', () => {
  const currentTask = ref<ResearchTask | null>(null);

  // åˆ›å»ºæ–°ç ”ç©¶ä»»åŠ¡
  const createTask = (taskId: string, query: string) => {
    currentTask.value = {
      task_id: taskId,
      query,
      status: 'idle',
      steps: [],
      panels: [],
      analyses: [],
    };
  };

  // æ›´æ–°ç ”ç©¶è®¡åˆ’
  const updatePlan = (plan: any) => {
    if (currentTask.value) {
      currentTask.value.plan = plan;
      currentTask.value.status = 'planning';
    }
  };

  // æ›´æ–°æ­¥éª¤
  const updateStep = (step: ResearchStep) => {
    if (!currentTask.value) return;

    const index = currentTask.value.steps.findIndex(s => s.step_id === step.step_id);
    if (index >= 0) {
      currentTask.value.steps[index] = step;
    } else {
      currentTask.value.steps.push(step);
    }

    // æ›´æ–°çŠ¶æ€
    if (step.status === 'processing') {
      currentTask.value.status = 'processing';
    }
  };

  // æ·»åŠ  Panel
  const addPanel = (panel: ResearchPanel) => {
    if (currentTask.value) {
      currentTask.value.panels.push(panel);
    }
  };

  // æ·»åŠ åˆ†æç»“æœ
  const addAnalysis = (analysis: ResearchAnalysis) => {
    if (currentTask.value) {
      currentTask.value.analyses.push(analysis);
    }
  };

  // å®Œæˆç ”ç©¶
  const completeTask = (metadata: any) => {
    if (currentTask.value) {
      currentTask.value.status = 'completed';
      currentTask.value.metadata = metadata;
    }
  };

  // é”™è¯¯å¤„ç†
  const errorTask = (error: string) => {
    if (currentTask.value) {
      currentTask.value.status = 'error';
      currentTask.value.error = error;
    }
  };

  // æ¸…ç©ºå½“å‰ä»»åŠ¡
  const clearTask = () => {
    currentTask.value = null;
  };

  // è®¡ç®—å±æ€§
  const isProcessing = computed(() => {
    return currentTask.value?.status === 'processing' ||
           currentTask.value?.status === 'planning';
  });

  const hasData = computed(() => {
    return (currentTask.value?.panels.length || 0) > 0;
  });

  const hasAnalysis = computed(() => {
    return (currentTask.value?.analyses.length || 0) > 0;
  });

  return {
    currentTask,
    createTask,
    updatePlan,
    updateStep,
    addPanel,
    addAnalysis,
    completeTask,
    errorTask,
    clearTask,
    isProcessing,
    hasData,
    hasAnalysis,
  };
});
```

#### 3. WebSocket Composable

**æ–°å¢æ–‡ä»¶**ï¼š`frontend/src/composables/useResearchWebSocket.ts`

```typescript
import { ref, onUnmounted } from 'vue';
import { useResearchViewStore } from '@/stores/researchViewStore';

export function useResearchWebSocket() {
  const researchStore = useResearchViewStore();
  const ws = ref<WebSocket | null>(null);
  const isConnected = ref(false);
  const error = ref<string | null>(null);

  const connect = (taskId: string, query: string) => {
    // WebSocket URL
    const wsUrl = `ws://localhost:8000/api/v1/research/stream`;

    console.log(`[Research WS] Connecting to ${wsUrl}`);
    ws.value = new WebSocket(wsUrl);

    ws.value.onopen = () => {
      console.log('[Research WS] Connected');
      isConnected.value = true;
      error.value = null;

      // å‘é€æŸ¥è¯¢è¯·æ±‚
      ws.value?.send(JSON.stringify({
        task_id: taskId,
        query,
        use_cache: true,
      }));
    };

    ws.value.onmessage = (event) => {
      const message = JSON.parse(event.data);
      console.log('[Research WS] Message:', message);

      switch (message.type) {
        case 'research_start':
          researchStore.updatePlan(message.plan);
          break;

        case 'research_step':
          researchStore.updateStep(message);
          break;

        case 'research_panel':
          researchStore.addPanel({
            sub_query: message.sub_query,
            data_source: message.data_source,
            item_count: message.item_count,
            panel_payload: message.panel_payload,
            data_blocks: message.data_blocks,
          });
          break;

        case 'research_analysis':
          researchStore.addAnalysis({
            query: message.query,
            summary: message.summary,
            item_count: message.item_count,
            execution_time: message.execution_time,
          });
          break;

        case 'research_complete':
          researchStore.completeTask(message.metadata);
          break;

        case 'research_error':
          researchStore.errorTask(message.error_message);
          error.value = message.error_message;
          break;
      }
    };

    ws.value.onerror = (event) => {
      console.error('[Research WS] Error:', event);
      error.value = 'è¿æ¥å¤±è´¥';
      researchStore.errorTask('WebSocket è¿æ¥å¤±è´¥');
    };

    ws.value.onclose = () => {
      console.log('[Research WS] Disconnected');
      isConnected.value = false;
    };
  };

  const disconnect = () => {
    if (ws.value) {
      ws.value.close();
      ws.value = null;
      isConnected.value = false;
    }
  };

  onUnmounted(() => {
    disconnect();
  });

  return {
    connect,
    disconnect,
    isConnected,
    error,
  };
}
```

#### 4. ç ”ç©¶è§†å›¾ä¸»ç»„ä»¶

**æ–°å¢æ–‡ä»¶**ï¼š`frontend/src/views/ResearchView.vue`

```vue
<template>
  <div class="research-view h-screen flex flex-col bg-background">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <ResearchTopBar
      :query="researchStore.currentTask?.query || ''"
      :is-processing="researchStore.isProcessing"
      @back="handleBack"
      @export="handleExport"
    />

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="flex-1 flex overflow-hidden">
      <!-- å·¦ä¾§ï¼šç ”ç©¶ä¸Šä¸‹æ–‡é¢æ¿ -->
      <div class="w-[30%] border-r border-border overflow-y-auto">
        <ResearchContextPanel
          :task="researchStore.currentTask"
        />
      </div>

      <!-- å³ä¾§ï¼šæ•°æ®å¯è§†åŒ–é¢æ¿ -->
      <div class="flex-1 overflow-y-auto bg-muted/20 p-6">
        <ResearchDataPanel
          :panels="researchStore.currentTask?.panels || []"
        />
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div
      v-if="!researchStore.currentTask"
      class="absolute inset-0 flex items-center justify-center bg-background/80"
    >
      <div class="text-center">
        <Loader class="h-8 w-8 animate-spin mx-auto mb-4" />
        <p class="text-muted-foreground">æ­£åœ¨åˆå§‹åŒ–ç ”ç©¶...</p>
      </div>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <Alert v-if="wsError" variant="destructive" class="absolute bottom-4 right-4 w-96">
      <AlertCircle class="h-4 w-4" />
      <AlertTitle>è¿æ¥é”™è¯¯</AlertTitle>
      <AlertDescription>{{ wsError }}</AlertDescription>
    </Alert>
  </div>
</template>

<script setup lang="ts">
import { onMounted, onUnmounted } from 'vue';
import { useRouter, useRoute } from 'vue-router';
import { useResearchViewStore } from '@/stores/researchViewStore';
import { useResearchWebSocket } from '@/composables/useResearchWebSocket';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';
import { Loader, AlertCircle } from 'lucide-vue-next';
import ResearchTopBar from '@/features/research/components/ResearchTopBar.vue';
import ResearchContextPanel from '@/features/research/components/ResearchContextPanel.vue';
import ResearchDataPanel from '@/features/research/components/ResearchDataPanel.vue';

const router = useRouter();
const route = useRoute();
const researchStore = useResearchViewStore();
const { connect, disconnect, error: wsError } = useResearchWebSocket();

// ä»è·¯ç”±å‚æ•°è·å–ä»»åŠ¡ä¿¡æ¯
const taskId = route.params.taskId as string;
const query = route.query.query as string;

onMounted(() => {
  if (!taskId || !query) {
    console.error('Missing taskId or query');
    router.push('/');
    return;
  }

  // åˆ›å»ºç ”ç©¶ä»»åŠ¡
  researchStore.createTask(taskId, query);

  // å»ºç«‹ WebSocket è¿æ¥
  connect(taskId, query);
});

onUnmounted(() => {
  disconnect();
  researchStore.clearTask();
});

const handleBack = () => {
  router.push('/');
};

const handleExport = () => {
  // TODO: å®ç°å¯¼å‡ºåŠŸèƒ½
  console.log('å¯¼å‡ºç ”ç©¶æŠ¥å‘Š');
};
</script>

<style scoped>
.research-view {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
</style>
```

---

## æ–‡ä»¶æ¸…å•

### åç«¯æ–°å¢/ä¿®æ”¹æ–‡ä»¶

1. **æ–°å¢**ï¼š`api/schemas/stream_messages.py`ï¼ˆæ‰©å±•ï¼‰
   - æ–°å¢ç ”ç©¶æ¶ˆæ¯ç±»å‹å®šä¹‰

2. **ä¿®æ”¹**ï¼š`services/chat_service.py`
   - æ–°å¢ `_handle_complex_research_streaming` æ–¹æ³•

3. **æ–°å¢**ï¼š`api/controllers/research_stream.py`
   - ç ”ç©¶ WebSocket ç«¯ç‚¹

4. **ä¿®æ”¹**ï¼š`api/app.py`
   - æ³¨å†Œæ–°è·¯ç”±

### å‰ç«¯æ–°å¢æ–‡ä»¶

1. **æ–°å¢**ï¼š`frontend/src/router/index.ts`
   - è·¯ç”±é…ç½®

2. **æ–°å¢**ï¼š`frontend/src/stores/researchViewStore.ts`
   - ç ”ç©¶è§†å›¾çŠ¶æ€ç®¡ç†

3. **æ–°å¢**ï¼š`frontend/src/composables/useResearchWebSocket.ts`
   - WebSocket è¿æ¥ç®¡ç†

4. **æ–°å¢**ï¼š`frontend/src/views/ResearchView.vue`
   - ç ”ç©¶è§†å›¾ä¸»å®¹å™¨

5. **æ–°å¢**ï¼š`frontend/src/features/research/components/ResearchTopBar.vue`
   - é¡¶éƒ¨å¯¼èˆªæ 

6. **æ–°å¢**ï¼š`frontend/src/features/research/components/ResearchContextPanel.vue`
   - å·¦ä¾§ä¸Šä¸‹æ–‡é¢æ¿

7. **æ–°å¢**ï¼š`frontend/src/features/research/components/ResearchDataPanel.vue`
   - å³ä¾§æ•°æ®é¢æ¿

8. **ä¿®æ”¹**ï¼š`frontend/src/App.vue`
   - æ”¹ä¸ºä½¿ç”¨ router-view

9. **ä¿®æ”¹**ï¼š`frontend/src/main.ts`
   - æ³¨å†Œ router

---

## å®æ–½æ­¥éª¤

### ç¬¬1æ­¥ï¼šåç«¯åŸºç¡€è®¾æ–½ï¼ˆDay 1ä¸Šåˆï¼‰

1. âœ… æ–°å¢æ¶ˆæ¯ç±»å‹å®šä¹‰
2. âœ… å®ç°æµå¼ç”Ÿæˆå™¨æ–¹æ³•
3. âœ… åˆ›å»º WebSocket ç«¯ç‚¹
4. âœ… æ³¨å†Œè·¯ç”±

### ç¬¬2æ­¥ï¼šå‰ç«¯è·¯ç”±å’ŒStoreï¼ˆDay 1ä¸‹åˆï¼‰

1. âœ… é…ç½® Vue Router
2. âœ… åˆ›å»º researchViewStore
3. âœ… å®ç° WebSocket composable

### ç¬¬3æ­¥ï¼šå‰ç«¯æ ¸å¿ƒç»„ä»¶ï¼ˆDay 2ä¸Šåˆï¼‰

1. âœ… å®ç° ResearchView ä¸»å®¹å™¨
2. âœ… å®ç° ResearchTopBar
3. âœ… å®ç°åŸºç¡€çš„ ResearchContextPanel
4. âœ… å®ç°åŸºç¡€çš„ ResearchDataPanel

### ç¬¬4æ­¥ï¼šæµ‹è¯•å’Œè°ƒè¯•ï¼ˆDay 2ä¸‹åˆï¼‰

1. âœ… ç«¯åˆ°ç«¯æµ‹è¯•
2. âœ… WebSocket è¿æ¥æµ‹è¯•
3. âœ… å®æ—¶æ¨é€æµ‹è¯•
4. âœ… è§†å›¾åˆ‡æ¢æµ‹è¯•

### ç¬¬5æ­¥ï¼šUIä¼˜åŒ–ï¼ˆDay 3ï¼‰

1. âœ… æ ·å¼ä¼˜åŒ–
2. âœ… å“åº”å¼å¸ƒå±€
3. âœ… åŠ è½½çŠ¶æ€
4. âœ… é”™è¯¯å¤„ç†

---

## å¼€å‘ä¼˜å…ˆçº§

### P0ï¼ˆå¿…é¡»ï¼ŒDay 1-2ï¼‰
- åç«¯æµå¼ç”Ÿæˆå™¨
- WebSocket è¿æ¥
- ç ”ç©¶è§†å›¾åŸºç¡€å¸ƒå±€
- å®æ—¶æ­¥éª¤æ›´æ–°
- Panel æ•°æ®å±•ç¤º
- åˆ†æç»“æœå±•ç¤º

### P1ï¼ˆDay 3-4ï¼‰
- UI/UX ä¼˜åŒ–
- é”™è¯¯å¤„ç†
- åŠ è½½çŠ¶æ€
- è¿”å›ä¸»ç•Œé¢

### P2ï¼ˆDay 5+ï¼‰
- è¿½é—®å¯¹è¯
- å¯¼å‡ºæŠ¥å‘Š
- åˆ†äº«åŠŸèƒ½

---

## æ³¨æ„äº‹é¡¹

1. **WebSocket è¿æ¥ç®¡ç†**
   - å®ç°å¿ƒè·³æœºåˆ¶
   - å®ç°è‡ªåŠ¨é‡è¿
   - å¤„ç†å¼‚å¸¸æ–­çº¿

2. **çŠ¶æ€ç®¡ç†**
   - ç ”ç©¶ä»»åŠ¡çŠ¶æ€è¦å®Œæ•´
   - Panel æ•°æ®è¦æ­£ç¡®ä¼ é€’
   - é¿å…å†…å­˜æ³„æ¼

3. **æ€§èƒ½ä¼˜åŒ–**
   - Panel æ•°æ®æ‡’åŠ è½½
   - è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¦‚æœPanelå¾ˆå¤šï¼‰
   - é˜²æŠ–å’ŒèŠ‚æµ

4. **ç”¨æˆ·ä½“éªŒ**
   - æµç•…çš„åŠ¨ç”»è¿‡æ¸¡
   - æ¸…æ™°çš„åŠ è½½çŠ¶æ€
   - å‹å¥½çš„é”™è¯¯æç¤º

---

## æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
- [ ] åç«¯æµå¼ç”Ÿæˆå™¨æµ‹è¯•
- [ ] Store çŠ¶æ€ç®¡ç†æµ‹è¯•
- [ ] WebSocket composable æµ‹è¯•

### é›†æˆæµ‹è¯•
- [ ] WebSocket ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] ç ”ç©¶è§†å›¾æ¸²æŸ“æµ‹è¯•
- [ ] è§†å›¾åˆ‡æ¢æµ‹è¯•

### æ‰‹åŠ¨æµ‹è¯•åœºæ™¯
1. å¯åŠ¨ç ”ç©¶ â†’ è§‚å¯Ÿå®æ—¶æ¨é€
2. ä¸­é€”æ–­å¼€ç½‘ç»œ â†’ è§‚å¯Ÿé”™è¯¯å¤„ç†
3. è¿”å›ä¸»ç•Œé¢ â†’ è§‚å¯ŸçŠ¶æ€æ¸…ç†
4. åˆ·æ–°é¡µé¢ â†’ è§‚å¯Ÿæ¢å¤é€»è¾‘

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

ç°åœ¨å¼€å§‹æŒ‰ç…§ä¼˜å…ˆçº§å®æ–½ï¼š

1. **åç«¯ P0**ï¼ˆå…ˆåšï¼‰
   - æ–°å¢æ¶ˆæ¯ç±»å‹
   - å®ç°æµå¼ç”Ÿæˆå™¨
   - åˆ›å»º WebSocket ç«¯ç‚¹

2. **å‰ç«¯ P0**ï¼ˆååšï¼‰
   - é…ç½®è·¯ç”±
   - åˆ›å»º Store
   - å®ç°ä¸»è¦ç»„ä»¶

å‡†å¤‡å¥½äº†å—ï¼Ÿæˆ‘ä»¬å¼€å§‹ç¼–å†™ä»£ç ï¼
